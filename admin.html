<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin</title>

<script src="config.js"></script>

<style>
body{
    font-family: Arial;
    padding:20px;
}

#panel{
    margin-top:20px;
    display:none;
}

textarea{
    width:400px;
    height:150px;
}
</style>

</head>
<body>

<h2>Admin</h2>

Пароль:
<input id="pass" type="password">
<button onclick="login()">Вход</button>

<div id="panel">

<h3>Добавить ученика:</h3>

Имя:<br>
<input id="name"><br><br>

Слова:<br>
<textarea id="words"></textarea><br>

<button onclick="add()">Добавить</button>

<div id="status"></div>

</div>

<script>

let fileData = null


function login(){

    if(document.getElementById("pass").value === CONFIG.adminPassword){

        document.getElementById("panel").style.display = "block"

    }else{

        alert("Неверный пароль")

    }

}



async function getFile(){

    const res = await fetch(
        `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.file}`,
        {
            headers:{
                Authorization:`Bearer ${CONFIG.token}`
            }
        }
    )

    const json = await res.json()

    const content =
        decodeURIComponent(
            escape(
                atob(json.content)
            )
        )

    return {
        sha: json.sha,
        data: JSON.parse(content)
    }

}



async function add(){

    const name =
        document.getElementById("name").value.trim()

    const words =
        document.getElementById("words").value.trim()

    if(!name || !words){

        alert("Введите имя и слова")
        return

    }


    const file = await getFile()

    const sha = file.sha

    const data = file.data


    data.students[name] =
        words.split("\n")
        .map(x=>x.trim())
        .filter(x=>x)


    const encoded =
        btoa(
            unescape(
                encodeURIComponent(
                    JSON.stringify(data,null,2)
                )
            )
        )


    const res = await fetch(
        `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.file}`,
        {
            method:"PUT",

            headers:{
                Authorization:`Bearer ${CONFIG.token}`,
                "Content-Type":"application/json"
            },

            body:JSON.stringify({
                message:"update students",
                content:encoded,
                sha:sha
            })
        }
    )


    if(res.ok){

        document.getElementById("status").innerHTML =
            "✅ Ученик добавлен"

    }else{

        document.getElementById("status").innerHTML =
            "❌ Ошибка: " + res.status

    }

}

</script>

</body>
</html>
