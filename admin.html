<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin</title>

<script src="config.js"></script>

<style>
body{
    font-family: Arial;
    padding:20px;
}

#panel{
    margin-top:20px;
    display:none;
}

textarea{
    width:400px;
    height:150px;
}

button{
    margin-top:10px;
}
</style>

</head>
<body>

<h2>Admin</h2>

Пароль:
<input id="pass" type="password">
<button onclick="login()">Вход</button>

<div id="panel">

<h3>Добавить ученика:</h3>

Имя:<br>
<input id="name"><br><br>

Слова:<br>
<textarea id="words"></textarea><br>

<button onclick="add()">Добавить</button>

<div id="status"></div>

</div>


<script>

let fileSha = null
let fileData = null


function login(){

    if(document.getElementById("pass").value === CONFIG.adminPassword){

        document.getElementById("panel").style.display = "block"
        load()

    }else{

        alert("Неверный пароль")

    }

}



async function load(){

    const res = await fetch(
        `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.file}`,
        {
            headers:{
                Authorization:`Bearer ${CONFIG.token}`
            }
        }
    )

    const json = await res.json()

    fileSha = json.sha

    const decoded =
        decodeURIComponent(
            escape(
                atob(json.content)
            )
        )

    fileData = JSON.parse(decoded)

}



async function add(){

    const name =
        document.getElementById("name").value.trim()

    const words =
        document.getElementById("words").value.trim()

    if(!name || !words){

        alert("Введите имя и слова")
        return

    }

    const list =
        words.split("\n").map(x=>x.trim()).filter(x=>x)

    fileData.students[name] = list


    const encoded =
        btoa(
            unescape(
                encodeURIComponent(
                    JSON.stringify(fileData,null,2)
                )
            )
        )


    const res = await fetch(
        `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.file}`,
        {
            method:"PUT",

            headers:{
                Authorization:`Bearer ${CONFIG.token}`,
                "Content-Type":"application/json"
            },

            body:JSON.stringify({
                message:"update students",
                content:encoded,
                sha:fileSha
            })
        }
    )

    if(res.ok){

        document.getElementById("status").innerHTML =
            "✅ Ученик добавлен"

        load()

    }else{

        document.getElementById("status").innerHTML =
            "❌ Ошибка"

    }

}

</script>

</body>
</html>
