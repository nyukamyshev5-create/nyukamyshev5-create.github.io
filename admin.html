<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Админ</title>
</head>

<body>

<h2>Админка</h2>

<input id="studentName" placeholder="Имя ученика">

<button onclick="addStudent()">Добавить</button>

<div id="students"></div>

<script>

const TOKEN="PASTE_NEW_TOKEN_HERE"
const USER="nyukamyshev5"
const REPO="nyukamyshev5-create"

let sha=""
let data={}

load()

async function load(){

const res=await fetch(
`https://api.github.com/repos/${USER}/${REPO}/contents/data.json`
)

const json=await res.json()

sha=json.sha

data=JSON.parse(atob(json.content))

render()

}

function render(){

const div=document.getElementById("students")

div.innerHTML=""

for(const name in data.students){

div.innerHTML+=`

<hr>

<h3>${name}</h3>

<textarea id="words_${name}" rows="10" cols="50">
${formatWords(name)}
</textarea>

<br>

<button onclick="saveWords('${name}')">
Сохранить слова
</button>

<button onclick="deleteStudent('${name}')">
Удалить ученика
</button>

<button onclick="showAttempts('${name}')">
Попытки
</button>

<div id="attempts_${name}"></div>

`

}

}

function formatWords(name){

return data.students[name].words
.map(w=>`${w.ru} = ${w.en}`)
.join("\n")

}

async function saveWords(name){

const text=
document.getElementById("words_"+name).value

const lines=text.split("\n")

data.students[name].words=[]

lines.forEach(line=>{

if(line.includes("=")){

const parts=line.split("=")

data.students[name].words.push({

ru:parts[0].trim(),
en:parts[1].trim()

})

}

})

await save()

}

async function addStudent(){

const name=
document.getElementById("studentName").value

data.students[name]={

words:[],
attempts:[]

}

await save()

}

async function deleteStudent(name){

delete data.students[name]

await save()

}

function showAttempts(name){

const div=
document.getElementById("attempts_"+name)

div.innerHTML=""

data.students[name].attempts
?.forEach(a=>{

div.innerHTML+=`
<div>
${a.date} — ${a.percent}%
</div>
`

})

}

async function save(){

const content=btoa(
JSON.stringify(data,null,2)
)

await fetch(
`https://api.github.com/repos/${USER}/${REPO}/contents/data.json`,
{
method:"PUT",

headers:{
Authorization:`Bearer ${TOKEN}`
},

body:JSON.stringify({

message:"update data",

content:content,

sha:sha

})

}
)

load()

}

</script>

</body>
</html>
