<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</title>
</head>
<body>

<h2>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h2>
<textarea id="instruction" rows="4" cols="50"></textarea>

<h2>–î–∏–∫—Ç–∞–Ω—Ç—ã —É—á–µ–Ω–∏–∫–æ–≤</h2>
<p>–§–æ—Ä–º–∞—Ç:</p>
<p>
–ò–º—è —É—á–µ–Ω–∏–∫–∞<br>
—Ä—É—Å—Å–∫–æ–µ:english<br>
—Ä—É—Å—Å–∫–æ–µ:english<br>
---<br>
–°–ª–µ–¥—É—é—â–∏–π —É—á–µ–Ω–∏–∫...
</p>

<textarea id="students" rows="15" cols="60"></textarea>
<br><br>

<button onclick="saveAll()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

<script>

const SETTINGS_BIN = "698f3a3043b1c97be97c510c";
const API_KEY = "$2a$10$sw1K/RXpKK2k3L5l6.wDLuJWKESzfg51etzmCpCb/Q6sEKy0Oudwi";

async function loadSettings(){

 let res = await fetch(`https://api.jsonbin.io/v3/b/${SETTINGS_BIN}/latest`,{
  headers:{"X-Master-Key":API_KEY}
 });

 let data = await res.json();
 let record = data.record;

 document.getElementById("instruction").value =
   record.instruction || "";

 let students = record.students || {};
 let text="";

 for(let name in students){

   text+=name+"\n";

   students[name].forEach(w=>{
     text+=`${w.ru}:${w.en}\n`;
   });

   text+="---\n";
 }

 document.getElementById("students").value=text;
}

async function saveAll(){

 let res = await fetch(`https://api.jsonbin.io/v3/b/${SETTINGS_BIN}/latest`,{
  headers:{"X-Master-Key":API_KEY}
 });

 let data = await res.json();
 let oldRecord = data.record;

 let instruction=document.getElementById("instruction").value;
 let raw=document.getElementById("students").value.split("---");

 let students={};

 raw.forEach(block=>{

   let lines=block.trim().split("\n").filter(l=>l.trim()!="");

   if(lines.length>1){

     let name=lines[0];
     students[name]=[];

     for(let i=1;i<lines.length;i++){
       let parts=lines[i].split(":");
       if(parts.length==2){
         students[name].push({
           ru:parts[0].trim(),
           en:parts[1].trim()
         });
       }
     }
   }
 });

 // üî• –í–ê–ñ–ù–û: —Å–æ—Ö—Ä–∞–Ω—è–µ–º results, —á—Ç–æ–±—ã –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ –ø—Ä–æ–ø–∞–¥–∞–ª–∏
 let newRecord = {
   instruction:instruction,
   students:students,
   results: oldRecord.results || {}
 };

 await fetch(`https://api.jsonbin.io/v3/b/${SETTINGS_BIN}`,{
  method:"PUT",
  headers:{
    "Content-Type":"application/json",
    "X-Master-Key":API_KEY
  },
  body:JSON.stringify(newRecord)
 });

 alert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
}

loadSettings();

</script>

</body>
</html>
