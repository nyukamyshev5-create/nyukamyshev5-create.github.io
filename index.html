<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Диктанты</title>

  <!-- Supabase JS v2 (2 CDN на случай блокировок) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // fallback если jsdelivr не загрузился
    if (!window.supabase) {
      document.write('<script src="https://unpkg.com/@supabase/supabase-js@2"><\/script>');
    }
  </script>

  <style>
    body{
      font-family:Arial, sans-serif;
      background:linear-gradient(135deg,#4e73df,#1cc88a);
      margin:0; padding:0;
      text-align:center;
      color:#111;
    }
    .container{
      background:#fff;
      max-width:920px;
      margin:30px auto;
      padding:24px;
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,0.2);
      text-align:left;
    }
    h2,h3{margin:10px 0 12px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .right{margin-left:auto;}
    button{
      padding:10px 14px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      background:#4e73df;
      color:#fff;
      font-weight:600;
    }
    button:hover{background:#2e59d9;}
    button.secondary{background:#6c757d;}
    button.danger{background:#dc3545;}
    button.ok{background:#198754;}
    .muted{color:#666; font-size:13px;}
    .panel{
      border:1px solid #e6e6e6;
      border-radius:14px;
      padding:16px;
      margin-top:14px;
      background:#fff;
    }
    input, textarea{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid #ccc;
      font-size:15px;
      box-sizing:border-box;
    }
    textarea{min-height:120px; resize:vertical;}
    hr{border:none; border-top:1px solid #eee; margin:14px 0;}
    .hidden{display:none !important;}
    .studentBtn{margin:4px 6px 0 0;}
    .wordRow{display:flex; gap:10px; align-items:center; margin:8px 0;}
    .wordRow .ru{width:42%; text-align:right;}
    .wordRow input{width:58%;}
    .correct{color:#198754; font-weight:700;}
    .wrong{color:#dc3545; font-weight:700;}
    .resultBox{margin-top:12px; border-top:1px dashed #ddd; padding-top:12px;}
    .attemptCard{
      border:1px solid #eee;
      border-radius:12px;
      padding:12px;
      margin:10px 0;
      background:#fafafa;
      text-align:left;
    }
    .smallBtn{padding:7px 10px; border-radius:9px; font-size:13px;}
    .notice{padding:10px; border-radius:12px; background:#fff3cd; border:1px solid #ffeeba;}
    .errorBox{padding:12px;border-radius:12px;background:#f8d7da;border:1px solid #f5c2c7;color:#842029;}
  </style>
</head>

<body>
  <div class="container">
    <div class="row">
      <h2 style="margin-right:auto;">Диктанты</h2>
      <button id="teacherToggleBtn" class="secondary">Вход для учителя</button>
    </div>

    <div id="fatalError" class="errorBox hidden"></div>

    <!-- УЧЕНИКИ -->
    <div class="panel">
      <h3>Выберите ученика</h3>
      <div id="studentsList" class="row" style="gap:6px;"></div>
      <div id="studentsEmpty" class="muted hidden">Пока нет учеников. Зайди как учитель и добавь.</div>
    </div>

    <!-- ТЕСТ -->
    <div id="testPanel" class="panel hidden">
      <div class="row">
        <h3 id="studentTitle">Ученик:</h3>
        <button id="newAttemptBtn" class="secondary right">Начать новую попытку</button>
      </div>

      <div class="panel" style="background:#fbfbfb;">
        <div id="instruction" style="white-space:pre-wrap;"></div>
        <hr>
        <b>Шкала оценок:</b><br>
        90–100% → 5<br>
        80–89% → 4<br>
        70–79% → 3<br>
        ниже 70% → 2
      </div>

      <hr>
      <form id="studentForm" autocomplete="off">
        <div id="words"></div>
        <div class="row" style="margin-top:10px;">
          <button type="button" id="sendBtn">Отправить</button>
        </div>
      </form>

      <div id="result" class="resultBox"></div>
    </div>

    <!-- УЧИТЕЛЬ -->
    <div id="teacherPanel" class="panel hidden">
      <h3>Личный кабинет учителя</h3>

      <div id="loginBox">
        <div class="row">
          <div style="flex:1;">
            <label><b>Пароль учителя</b></label>
            <input id="teacherPass" type="password" placeholder="tutorai"
                   autocomplete="new-password" autocapitalize="off" spellcheck="false">
          </div>
          <div style="width:140px; align-self:flex-end;">
            <button id="teacherLoginBtn">Войти</button>
          </div>
        </div>
        <div id="loginMsg" class="muted" style="margin-top:8px;"></div>
      </div>

      <div id="teacherBox" class="hidden">
        <div class="notice">
          Важно: вставка/копирование блокируются <b>только у ученика</b>. В кабинете учителя Ctrl+V работает.
        </div>

        <hr>

        <h3>Инструкция (общая)</h3>
        <textarea id="tInstruction" rows="5" placeholder="Инструкция для всех учеников..."></textarea>
        <div class="row">
          <button id="saveInstructionBtn" class="ok">Сохранить инструкцию</button>
          <span id="instrMsg" class="muted"></span>
        </div>

        <hr>

        <h3>Создать / обновить диктант ученика</h3>
        <div class="row">
          <div style="flex:1;">
            <label><b>Имя ученика</b></label>
            <input id="tStudentName" placeholder="Например: Ксения" autocomplete="off" spellcheck="false">
          </div>
        </div>

        <label style="display:block;margin-top:8px;">
          <b>Слова</b> <span class="muted">(формат: русское = english или русское:english)</span>
        </label>
        <textarea id="tWords" placeholder="долгосрочный спад = long-term decline&#10;десятилетие = decade&#10;отчёт = report"></textarea>

        <div class="row">
          <button id="saveStudentBtn" class="ok">Сохранить ученика</button>
          <button id="clearFormBtn" class="secondary">Очистить поля</button>
          <span id="studentMsg" class="muted"></span>
        </div>

        <hr>

        <h3>Ученики</h3>
        <div id="teacherStudents"></div>

        <hr>

        <h3>Результаты</h3>
        <div class="muted">Нажми “Попытки” рядом с учеником — увидишь все попытки и детализацию каждой попытки.</div>
        <div id="resultsBox"></div>
      </div>
    </div>
  </div>

<script>
/** ====== ТВОИ ДАННЫЕ SUPABASE ====== */
const SUPABASE_URL = "https://fbpetpkozxvftrhymade.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_IL-eG_ifkskxSMPa2NtnQg_obuFuar9";

/** ====== ПАРОЛЬ УЧИТЕЛЯ ====== */
const TEACHER_PASSWORD = "tutorai";

/** ====== ГЛОБАЛЫ ====== */
let currentStudent = "";
let currentItems = [];
let teacherMode = false;
let supa = null;

/** ====== UI helpers ====== */
function showFatal(msg){
  const box = document.getElementById("fatalError");
  box.textContent = msg;
  box.classList.remove("hidden");
}
function hideFatal(){
  document.getElementById("fatalError").classList.add("hidden");
}

/** ====== утилиты ====== */
function normalizeAnswer(s){
  return (s || "").trim().replace(/\s+/g," ").toLowerCase();
}
function calcGrade(percent){
  if (percent >= 90) return 5;
  if (percent >= 80) return 4;
  if (percent >= 70) return 3;
  return 2;
}
function escapeHtml(str){
  return (str ?? "").toString()
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function parseWords(text){
  const lines = (text || "").split("\n").map(l=>l.trim()).filter(Boolean);
  const items = [];
  for (const line of lines){
    const m = line.match(/^(.+?)\s*(?:=|:)\s*(.+)$/);
    if (!m) continue;
    const ru = m[1].trim();
    const en = m[2].trim();
    if (ru && en) items.push({ru,en});
  }
  return items;
}

/** ====== анти-чит только ученику ====== */
function setStudentRestrictions(on){
  const form = document.getElementById("studentForm");
  if (!form) return;

  form.oncopy = form.oncut = form.onpaste = form.ondrop = form.ondragover = null;
  document.oncontextmenu = null;
  document.onkeydown = null;

  if (!on) return;

  form.oncopy = (e)=>e.preventDefault();
  form.oncut  = (e)=>e.preventDefault();
  form.onpaste= (e)=>e.preventDefault();
  form.ondrop = (e)=>e.preventDefault();
  form.ondragover = (e)=>e.preventDefault();

  document.oncontextmenu = (e)=>{
    const testVisible = !document.getElementById("testPanel").classList.contains("hidden");
    if (testVisible) e.preventDefault();
  };

  document.onkeydown = (e)=>{
    const testVisible = !document.getElementById("testPanel").classList.contains("hidden");
    if (!testVisible) return;
    const key = (e.key||"").toLowerCase();
    const ctrl = e.ctrlKey || e.metaKey;
    if (ctrl && (key==="v" || key==="c" || key==="x" || key==="a")) e.preventDefault();
  };
}

/** ====== рендер слов ====== */
function renderWords(items){
  const wrap = document.getElementById("words");
  wrap.innerHTML = "";

  const bait = document.createElement("input");
  bait.type = "text";
  bait.style.position = "absolute";
  bait.style.left = "-9999px";
  bait.autocomplete = "username";
  wrap.appendChild(bait);

  items.forEach((w,i)=>{
    const row = document.createElement("div");
    row.className = "wordRow";
    row.innerHTML = `
      <div class="ru">${escapeHtml(w.ru)}</div>
      <input id="w${i}" type="text"
        autocapitalize="off" spellcheck="false"
        autocomplete="off"
      />
    `;
    wrap.appendChild(row);
    const inp = row.querySelector("input");
    inp.readOnly = true;
    inp.addEventListener("focus", ()=>{ inp.readOnly = false; });
    inp.name = "ans_"+i+"_"+Math.random().toString(16).slice(2);
  });
}

/** ====== Supabase init ====== */
function initSupabase(){
  if (!window.supabase || !window.supabase.createClient) {
    showFatal("Не загрузилась библиотека Supabase (CDN). Из-за этого кнопки и данные не работают. Попробуй обновить страницу (Ctrl+F5). Если не поможет — интернет/провайдер блокирует CDN. Тогда скажи — дам вариант без CDN (локальный файл).");
    return false;
  }
  supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  hideFatal();
  return true;
}

/** ====== data загрузка ====== */
async function loadStudentsButtons(){
  const list = document.getElementById("studentsList");
  const empty = document.getElementById("studentsEmpty");
  list.innerHTML = "";

  if (!supa) { empty.classList.remove("hidden"); return; }

  const { data, error } = await supa.from("dictations")
    .select("student_name")
    .order("student_name", { ascending:true });

  if (error){
    empty.classList.remove("hidden");
    empty.textContent = "Ошибка загрузки учеников: " + error.message;
    return;
  }

  const students = (data || []).filter(r => r.student_name !== "__global__");

  if (students.length === 0){
    empty.classList.remove("hidden");
    empty.textContent = "Пока нет учеников. Зайди как учитель и добавь.";
    return;
  }
  empty.classList.add("hidden");

  students.forEach(row=>{
    const btn = document.createElement("button");
    btn.className = "studentBtn";
    btn.textContent = row.student_name;
    btn.onclick = ()=> startTest(row.student_name);
    list.appendChild(btn);
  });
}

async function loadInstruction(){
  if (!supa) return "";
  const { data } = await supa.from("dictations")
    .select("instruction")
    .eq("student_name","__global__")
    .maybeSingle();
  return data?.instruction || "";
}

async function saveGlobalInstruction(text){
  const { error } = await supa.from("dictations").upsert({
    student_name:"__global__",
    instruction:text||"",
    items:[],
    updated_at:new Date().toISOString()
  }, { onConflict:"student_name" });
  return error;
}

/** ====== student test ====== */
async function startTest(name){
  if (!supa){ alert("Supabase не загрузился, тест не работает."); return; }

  currentStudent = name;

  const { data, error } = await supa.from("dictations")
    .select("student_name, instruction, items")
    .eq("student_name", name)
    .single();

  if (error){ alert("Не удалось загрузить диктант: "+error.message); return; }

  const globalInstr = await loadInstruction();
  const mergedInstr = [globalInstr, data.instruction].filter(Boolean).join("\n");

  currentItems = Array.isArray(data.items) ? data.items : [];

  document.getElementById("studentTitle").textContent = "Ученик: " + name;
  document.getElementById("instruction").textContent = mergedInstr || "";
  renderWords(currentItems);

  document.getElementById("result").innerHTML = "";
  document.getElementById("testPanel").classList.remove("hidden");

  setStudentRestrictions(true);
}

async function submitAttempt(){
  if (!supa){ alert("Supabase не загрузился, сохранение не работает."); return; }
  if (!currentStudent || !currentItems.length){ alert("Нет слов для теста."); return; }

  let correct = 0;
  const details = [];

  currentItems.forEach((w,i)=>{
    const val = (document.getElementById("w"+i)?.value || "").trim();
    const ok = normalizeAnswer(val) === normalizeAnswer(w.en);
    if (ok) correct++;
    details.push({ ru:w.ru, correct:w.en, answer:val, ok });
  });

  const percent = Math.round((correct / currentItems.length) * 100);
  const grade = calcGrade(percent);

  let html = `<h3>Результат: ${percent}% • Оценка: ${grade}</h3><hr>`;
  details.forEach(d=>{
    if (d.ok){
      html += `<div class="correct">✅ ${escapeHtml(d.ru)} → ${escapeHtml(d.answer)}</div>`;
    } else {
      html += `<div class="wrong">❌ ${escapeHtml(d.ru)} → ${escapeHtml(d.answer||"(пусто)")} — ошибка (правильно: <b>${escapeHtml(d.correct)}</b>)</div>`;
    }
  });
  document.getElementById("result").innerHTML = html;

  const { data: maxRow } = await supa.from("attempts")
    .select("attempt_no")
    .eq("student_name", currentStudent)
    .order("attempt_no", { ascending:false })
    .limit(1);

  const last = (maxRow && maxRow[0]) ? maxRow[0].attempt_no : 0;

  const { error } = await supa.from("attempts").insert({
    student_name: currentStudent,
    attempt_no: last + 1,
    percent, grade,
    details
  });

  if (error) alert("Не удалось сохранить попытку: "+error.message);
}

function newAttempt(){
  currentItems.forEach((_,i)=>{
    const inp = document.getElementById("w"+i);
    if (inp) inp.value = "";
  });
  document.getElementById("result").innerHTML = "";
}

/** ====== teacher UI ====== */
function toggleTeacherPanel(){
  const p = document.getElementById("teacherPanel");
  p.classList.toggle("hidden");
  if (!p.classList.contains("hidden")) setStudentRestrictions(false);
}

function teacherLogin(){
  const pass = document.getElementById("teacherPass").value;
  const msg = document.getElementById("loginMsg");

  if (pass !== TEACHER_PASSWORD){
    msg.textContent = "Неверный пароль.";
    return;
  }
  msg.textContent = "";
  teacherMode = true;

  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("teacherBox").classList.remove("hidden");

  initTeacherData();
}

async function initTeacherData(){
  if (!supa){ alert("Supabase не загрузился — кабинет не сможет сохранять."); return; }
  document.getElementById("tInstruction").value = await loadInstruction();
  await renderTeacherStudents();
}

async function renderTeacherStudents(){
  const box = document.getElementById("teacherStudents");
  box.innerHTML = "";
  if (!supa){ box.innerHTML = `<div class="muted">Supabase не загружен.</div>`; return; }

  const { data, error } = await supa.from("dictations")
    .select("student_name, updated_at")
    .neq("student_name","__global__")
    .order("student_name", { ascending:true });

  if (error){ box.innerHTML = `<div class="muted">Ошибка: ${escapeHtml(error.message)}</div>`; return; }
  if (!data || data.length === 0){ box.innerHTML = `<div class="muted">Пока нет учеников.</div>`; return; }

  data.forEach(row=>{
    const wrap = document.createElement("div");
    wrap.className = "attemptCard";
    wrap.innerHTML = `
      <div class="row">
        <div><b>${escapeHtml(row.student_name)}</b></div>
        <div class="right muted">обновлён: ${new Date(row.updated_at).toLocaleString()}</div>
      </div>
      <div class="row" style="margin-top:8px;">
        <button class="smallBtn" data-act="edit">Редактировать</button>
        <button class="smallBtn" data-act="attempts">Попытки</button>
        <button class="smallBtn danger" data-act="delete">Удалить</button>
      </div>
    `;
    wrap.querySelector('[data-act="edit"]').onclick = ()=>loadStudentIntoForm(row.student_name);
    wrap.querySelector('[data-act="attempts"]').onclick = ()=>showAttempts(row.student_name);
    wrap.querySelector('[data-act="delete"]').onclick = ()=>deleteStudent(row.student_name);
    box.appendChild(wrap);
  });
}

async function saveInstructionTeacher(){
  if (!supa){ alert("Supabase не загружен."); return; }
  const text = document.getElementById("tInstruction").value || "";
  const msg = document.getElementById("instrMsg");
  msg.textContent = "Сохранение...";
  const err = await saveGlobalInstruction(text);
  msg.textContent = err ? ("Ошибка: "+err.message) : "✅ Сохранено";
}

async function saveOrUpdateStudent(){
  if (!supa){ alert("Supabase не загружен."); return; }

  const name = (document.getElementById("tStudentName").value || "").trim();
  const wordsText = document.getElementById("tWords").value || "";
  const msg = document.getElementById("studentMsg");
  msg.textContent = "";

  if (!name){ msg.textContent = "Введите имя ученика."; return; }
  const items = parseWords(wordsText);
  if (items.length === 0){ msg.textContent = "Не вижу слов. Пример: отчёт = report"; return; }

  msg.textContent = "Сохранение...";
  const { error } = await supa.from("dictations").upsert({
    student_name:name,
    instruction:"",
    items:items,
    updated_at:new Date().toISOString()
  }, { onConflict:"student_name" });

  if (error){ msg.textContent = "Ошибка: "+error.message; return; }

  msg.textContent = "✅ Сохранено";
  document.getElementById("tStudentName").value = "";
  document.getElementById("tWords").value = "";

  await loadStudentsButtons();
  await renderTeacherStudents();
}

function clearTeacherForm(){
  document.getElementById("tStudentName").value = "";
  document.getElementById("tWords").value = "";
  document.getElementById("studentMsg").textContent = "";
}

async function loadStudentIntoForm(name){
  const { data, error } = await supa.from("dictations")
    .select("student_name, items")
    .eq("student_name", name)
    .single();
  if (error){ alert("Ошибка: "+error.message); return; }
  document.getElementById("tStudentName").value = data.student_name;
  const items = Array.isArray(data.items) ? data.items : [];
  document.getElementById("tWords").value = items.map(it=>`${it.ru} = ${it.en}`).join("\n");
  document.getElementById("studentMsg").textContent = "Загружено для редактирования.";
}

async function deleteStudent(name){
  if (!confirm(`Удалить ученика "${name}" и все его попытки?`)) return;
  const { error: e1 } = await supa.from("attempts").delete().eq("student_name", name);
  const { error: e2 } = await supa.from("dictations").delete().eq("student_name", name);
  if (e1 || e2){ alert("Ошибка удаления: "+(e1?.message||e2?.message)); return; }
  document.getElementById("resultsBox").innerHTML = "";
  await loadStudentsButtons();
  await renderTeacherStudents();
}

async function showAttempts(name){
  const box = document.getElementById("resultsBox");
  box.innerHTML = `<div class="muted">Загрузка попыток для ${escapeHtml(name)}...</div>`;

  const { data, error } = await supa.from("attempts")
    .select("attempt_no, percent, grade, details, created_at")
    .eq("student_name", name)
    .order("attempt_no", { ascending:true });

  if (error){ box.innerHTML = `<div class="muted">Ошибка: ${escapeHtml(error.message)}</div>`; return; }
  if (!data || data.length===0){ box.innerHTML = `<div class="attemptCard"><b>${escapeHtml(name)}</b><div class="muted">Нет попыток.</div></div>`; return; }

  let html = `<div class="attemptCard"><b>${escapeHtml(name)}</b><div class="muted">Всего попыток: ${data.length}</div></div>`;
  data.forEach(a=>{
    html += `
      <div class="attemptCard">
        <div class="row">
          <div><b>Попытка ${a.attempt_no}</b></div>
          <div class="right muted">${new Date(a.created_at).toLocaleString()}</div>
        </div>
        <div style="margin-top:6px;">Итог: <b>${a.percent}%</b> • Оценка: <b>${a.grade}</b></div>
        <hr>
        <div>
          ${(Array.isArray(a.details)?a.details:[]).map(d=>{
            return d.ok
              ? `<div class="correct">✅ ${escapeHtml(d.ru)} → ${escapeHtml(d.answer||"")}</div>`
              : `<div class="wrong">❌ ${escapeHtml(d.ru)} → ${escapeHtml(d.answer||"(пусто)")} — ошибка (правильно: <b>${escapeHtml(d.correct)}</b>)</div>`;
          }).join("")}
        </div>
      </div>
    `;
  });
  box.innerHTML = html;
}

/** ====== DOM READY ====== */
window.addEventListener("DOMContentLoaded", async ()=>{
  // КНОПКИ (работают даже если Supabase не загрузился)
  document.getElementById("teacherToggleBtn").addEventListener("click", toggleTeacherPanel);
  document.getElementById("teacherLoginBtn").addEventListener("click", (e)=>{ e.preventDefault(); teacherLogin(); });
  document.getElementById("saveInstructionBtn").addEventListener("click", (e)=>{ e.preventDefault(); saveInstructionTeacher(); });
  document.getElementById("saveStudentBtn").addEventListener("click", (e)=>{ e.preventDefault(); saveOrUpdateStudent(); });
  document.getElementById("clearFormBtn").addEventListener("click", (e)=>{ e.preventDefault(); clearTeacherForm(); });
  document.getElementById("sendBtn").addEventListener("click", (e)=>{ e.preventDefault(); submitAttempt(); });
  document.getElementById("newAttemptBtn").addEventListener("click", (e)=>{ e.preventDefault(); newAttempt(); });

  // Сначала отключаем ограничения
  setStudentRestrictions(false);

  // Инициализация Supabase
  const ok = initSupabase();
  if (ok) await loadStudentsButtons();
});
</script>
</body>
</html>
