<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Диктант</title>
</head>

<body>

<h1>Переведи слова</h1>

<button onclick="adminLogin()">Вход для администратора</button>
<br><br>

Имя:<br>
<input id="name"><br><br>

<div id="words"></div>

<button onclick="send()">Отправить</button>

<h2 id="result"></h2>

<script>

const SETTINGS_BIN = "698f3a3043b1c97be97c510c";
const RESULTS_BIN = "698f3a5c43b1c97be97c5186";
const API_KEY = "$2a$10$sw1K/RXpKK2k3L5l6.wDLuJWKESzfg51etzmCpCb/Q6sEKy0Oudwi";

let words = [];

async function loadWords() {
  let res = await fetch(`https://api.jsonbin.io/v3/b/${SETTINGS_BIN}/latest`, {
    headers: {"X-Master-Key": API_KEY}
  });

  let data = await res.json();
  words = data.record.words;

  let html = "";
  words.forEach((w,i)=>{
    html += w.ru + "<br>";
    html += `<input id="w${i}"><br><br>`;
  });

  document.getElementById("words").innerHTML = html;
}

async function send() {

  let name = document.getElementById("name").value;

  let correct = 0;
  let answers = [];

  words.forEach((w,i)=>{
    let val = document.getElementById("w"+i).value.trim().toLowerCase();

    if(val === w.en.toLowerCase()) correct++;

    answers.push({
      ru: w.ru,
      correct: w.en,
      answer: val
    });
  });

  document.getElementById("result").innerText =
    `Результат: ${correct} из ${words.length}`;

  let res = await fetch(`https://api.jsonbin.io/v3/b/${RESULTS_BIN}/latest`, {
    headers: {"X-Master-Key": API_KEY}
  });

  let data = await res.json();
  let results = data.record.results;

  results.push({
    name: name,
    score: `${correct}/${words.length}`,
    answers: answers
  });

  await fetch(`https://api.jsonbin.io/v3/b/${RESULTS_BIN}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Master-Key": API_KEY
    },
    body: JSON.stringify({results})
  });
}

function adminLogin() {
  let pass = prompt("Введите пароль администратора");

  if(pass === "admin123") {
    location.href = "admin.html";
  }
}

loadWords();

</script>
</body>
</html>
