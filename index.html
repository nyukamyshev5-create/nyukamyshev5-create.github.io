<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Диктант</title>
<style>
.correct { color: green; font-weight: bold; }
.wrong { color: red; font-weight: bold; }
.box { margin-bottom: 10px; }
</style>
</head>

<body>

<h1>Переведи слова</h1>

<button onclick="adminLogin()">Вход для администратора</button>
<br><br>

Имя:<br>
<input id="name"><br><br>

<div id="words"></div>

<button onclick="send()">Отправить</button>

<div id="result"></div>

<script>

const SETTINGS_BIN = "698f3a3043b1c97be97c510c";
const RESULTS_BIN = "698f3a5c43b1c97be97c5186";
const API_KEY = "$2a$10$sw1K/RXpKK2k3L5l6.wDLuJWKESzfg51etzmCpCb/Q6sEKy0Oudwi";

let words = [];

async function loadWords() {

  let res = await fetch(`https://api.jsonbin.io/v3/b/${SETTINGS_BIN}/latest`, {
    headers: {"X-Master-Key": API_KEY}
  });

  let data = await res.json();
  words = data.record.words || [];

  let html = "";

  words.forEach((w,i)=>{
    html += `
      <div class="box">
        ${w.ru}<br>
        <input id="w${i}">
      </div>
    `;
  });

  document.getElementById("words").innerHTML = html;
}

async function send() {

  let name = document.getElementById("name").value.trim();

  if(!name){
    alert("Введите имя");
    return;
  }

  let correct = 0;
  let answers = [];
  let resultHTML = "";

  words.forEach((w,i)=>{

    let input = document.getElementById("w"+i);
    let val = input.value.trim().toLowerCase();

    if(val === w.en.toLowerCase()) {
      correct++;
      resultHTML += `
        <p class="correct">
          ${w.ru} → ${val} ✅
        </p>
      `;
    } else {
      resultHTML += `
        <p class="wrong">
          ${w.ru} → ${val || "(пусто)"} ❌ Ошибка.
          Правильно: <b>${w.en}</b>
        </p>
      `;
    }

    answers.push({
      ru: w.ru,
      correct: w.en,
      answer: val
    });
  });

  let percent = words.length > 0 
    ? Math.round((correct / words.length) * 100) 
    : 0;

  document.getElementById("result").innerHTML =
    `
      <h2>Результат: ${correct} из ${words.length}</h2>
      <h3>Процент выполнения: ${percent}%</h3>
    `
    + resultHTML;

  // === сохраняем результат ===
  let res = await fetch(`https://api.jsonbin.io/v3/b/${RESULTS_BIN}/latest`, {
    headers: {"X-Master-Key": API_KEY}
  });

  let data = await res.json();
  let results = data.record.results || [];

  results.push({
    name: name,
    score: `${correct}/${words.length}`,
    percent: percent + "%",
    answers: answers,
    date: new Date().toLocaleString()
  });

  await fetch(`https://api.jsonbin.io/v3/b/${RESULTS_BIN}`, {
    method: "PUT",
    headers: {
      "Content-Type": "application/json",
      "X-Master-Key": API_KEY
    },
    body: JSON.stringify({results})
  });

}

function adminLogin() {
  let pass = prompt("Введите пароль администратора");

  if(pass === "admin123") {
    location.href = "admin.html";
  } else {
    alert("Неверный пароль");
  }
}

loadWords();

</script>

</body>
</html>
