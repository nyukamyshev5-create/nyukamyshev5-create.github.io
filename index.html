<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Диктанты</title>

<script src="config.js"></script>

<style>
body{
font-family:Arial;
background:linear-gradient(135deg,#4e73df,#1cc88a);
margin:0;
padding:0;
text-align:center;
}

.container{
background:white;
max-width:700px;
margin:40px auto;
padding:30px;
border-radius:15px;
box-shadow:0 10px 30px rgba(0,0,0,0.2);
}

button{
padding:10px;
margin:5px;
}
.correct{color:green;}
.wrong{color:red;}
#test{display:none;}
</style>
</head>
<body>

<div class="container">

<h2>Выберите ученика</h2>
<div id="studentsList"></div>

<hr>

<div id="test">

<h3 id="studentTitle"></h3>
<p id="instruction"></p>

<div id="words"></div>

<button onclick="send()">Отправить</button>

<div id="result"></div>

</div>

</div>

<script>

let words=[]
let currentStudent=""
let sha=""

async function loadData(){

const res=await fetch(
`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.file}`,
{
headers:{Authorization:`Bearer ${CONFIG.token}`}
})

const json=await res.json()

sha=json.sha

return JSON.parse(atob(json.content))

}

async function loadStudents(){

const data=await loadData()

let html=""

for(let name in data.students){

html+=`<button onclick="startTest('${name}')">${name}</button>`

}

document.getElementById("studentsList").innerHTML=html

}

async function startTest(name){

currentStudent=name

const data=await loadData()

words=data.students[name]

document.getElementById("studentTitle").innerText=name
document.getElementById("instruction").innerText=data.instruction

let html=""

words.forEach((w,i)=>{

html+=`${w.ru}<input id="w${i}"><br>`

})

document.getElementById("words").innerHTML=html

document.getElementById("test").style.display="block"

}

async function send(){

let correct=0
let details=[]

words.forEach((w,i)=>{

let val=document.getElementById("w"+i).value.trim()

let ok=val.toLowerCase()==w.en.toLowerCase()

if(ok)correct++

details.push({
ru:w.ru,
correct:w.en,
answer:val,
ok:ok
})

})

let percent=Math.round(correct/words.length*100)

let grade=2

if(percent>=90)grade=5
else if(percent>=80)grade=4
else if(percent>=70)grade=3

let html=`<h2>${percent}%</h2><h2>Оценка ${grade}</h2>`

document.getElementById("result").innerHTML=html

saveResult(percent,details)

}

async function saveResult(percent,details){

let data=await loadData()

if(!data.results)data.results={}

data.results[currentStudent]={percent,details}

await fetch(
`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.file}`,
{
method:"PUT",
headers:{
Authorization:`Bearer ${CONFIG.token}`,
"Content-Type":"application/json"
},
body:JSON.stringify({
message:"update result",
content:btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2)))),
sha:sha
})
})

}

loadStudents()

</script>

</body>
</html>
