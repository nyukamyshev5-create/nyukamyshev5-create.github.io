<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Диктанты</title>

<style>
body{
 font-family:Arial;
 background:linear-gradient(135deg,#4e73df,#1cc88a);
 margin:0;
 padding:20px;
}

.panel{
 background:white;
 padding:20px;
 border-radius:12px;
 max-width:900px;
 margin:auto;
 margin-bottom:20px;
 box-shadow:0 8px 25px rgba(0,0,0,0.15);
}

button{
 padding:8px 14px;
 margin:5px;
 border:none;
 border-radius:8px;
 background:#4e73df;
 color:white;
 cursor:pointer;
}

button:hover{
 background:#2e59d9;
}

input,textarea{
 width:100%;
 padding:6px;
 margin:5px 0;
}

.hidden{
 display:none;
}

.correct{color:green;}
.wrong{color:red;}
</style>

</head>
<body>

<div class="panel">

<h2>Выберите ученика</h2>
<div id="studentsList"></div>

<button onclick="showTutorLogin()">Вход для учителя</button>

</div>


<div id="testPanel" class="panel hidden">

<h3 id="studentName"></h3>
<p id="instruction"></p>

<div id="words"></div>

<button onclick="finishTest()">Отправить</button>

<div id="result"></div>

</div>


<div id="tutorLogin" class="panel hidden">

<h3>Пароль учителя</h3>

<input type="password" id="tutorPass">
<button onclick="loginTutor()">Войти</button>

</div>


<div id="tutorPanel" class="panel hidden">

<h3>Инструкция</h3>

<textarea id="instructionEdit"></textarea>

<button onclick="saveInstruction()">Сохранить инструкцию</button>

<hr>

<h3>Добавить ученика</h3>

<input id="studentNameInput" placeholder="Имя">

<textarea id="studentWordsInput"
placeholder="кот:cat
дом:house"></textarea>

<button onclick="addStudent()">Сохранить ученика</button>

<hr>

<h3>Ученики</h3>

<div id="studentsEdit"></div>

<hr>

<h3>Результаты</h3>

<div id="results"></div>

</div>


<script>

const BIN_ID="698f3a3043b1c97be97c510c ";
const API_KEY="$2a$10$sw1K/RXpKK2k3L5l6.wDLuJWKESzfg51etzmCpCb/Q6sEKy0Oudwi";

const PASSWORD="tutorai";

let data={};
let currentStudent="";
let words=[];



async function loadData(){

 let res=await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`,{
  headers:{
   "X-Master-Key":API_KEY
  }
 });

 let json=await res.json();

 data=json.record;

 if(!data.students) data.students={};
 if(!data.results) data.results={};

 showStudents();
 showTutorStudents();
 showResults();

}



function showStudents(){

 let html="";

 for(let name in data.students){

  html+=`<button onclick="startTest('${name}')">${name}</button>`;

 }

 document.getElementById("studentsList").innerHTML=html;

}



function startTest(name){

 currentStudent=name;

 words=data.students[name];

 document.getElementById("studentName").innerText=name;

 document.getElementById("instruction").innerText=data.instruction;

 let html="";

 words.forEach((w,i)=>{

  html+=`${w.ru}<input id="w${i}"><br>`;

 });

 document.getElementById("words").innerHTML=html;

 document.getElementById("testPanel").classList.remove("hidden");

}



async function finishTest(){

 let correct=0;
 let details=[];

 words.forEach((w,i)=>{

  let val=document.getElementById("w"+i).value.trim();

  let ok=val.toLowerCase()==w.en.toLowerCase();

  if(ok) correct++;

  details.push({
   ru:w.ru,
   correct:w.en,
   answer:val,
   ok:ok
  });

 });

 let percent=Math.round(correct/words.length*100);

 if(!data.results[currentStudent])
  data.results[currentStudent]=[];

 data.results[currentStudent].push({
  percent:percent,
  date:new Date().toLocaleString()
 });

 await saveData();

 let html=`<h3>Результат: ${percent}%</h3>`;

 details.forEach(d=>{

  if(d.ok)
   html+=`<div class="correct">${d.ru} ✓</div>`;
  else
   html+=`<div class="wrong">${d.ru} ✗ (${d.correct})</div>`;

 });

 document.getElementById("result").innerHTML=html;

 showResults();

}



function showTutorLogin(){

 document.getElementById("tutorLogin").classList.remove("hidden");

}



function loginTutor(){

 if(document.getElementById("tutorPass").value!=PASSWORD){

  alert("Неверный пароль");
  return;

 }

 document.getElementById("tutorPanel").classList.remove("hidden");

 document.getElementById("instructionEdit").value=data.instruction;

}



async function saveInstruction(){

 data.instruction=document.getElementById("instructionEdit").value;

 await saveData();

 alert("Сохранено");

}



async function addStudent(){

 let name=document.getElementById("studentNameInput").value.trim();

 let raw=document.getElementById("studentWordsInput").value.split("\n");

 let arr=[];

 raw.forEach(line=>{

  let parts=line.split(":");

  if(parts.length==2)
   arr.push({
    ru:parts[0].trim(),
    en:parts[1].trim()
   });

 });

 data.students[name]=arr;

 await saveData();

 showStudents();
 showTutorStudents();

 alert("Сохранено");

}



function showTutorStudents(){

 let html="";

 for(let name in data.students){

  html+=`
   ${name}
   <button onclick="deleteStudent('${name}')">Удалить</button>
   <br>
  `;

 }

 document.getElementById("studentsEdit").innerHTML=html;

}



async function deleteStudent(name){

 delete data.students[name];

 await saveData();

 showStudents();
 showTutorStudents();

}



function showResults(){

 let html="";

 for(let name in data.results){

  html+=`<b>${name}</b><br>`;

  data.results[name].forEach(r=>{

   html+=`${r.percent}% (${r.date})<br>`;

  });

  html+="<br>";

 }

 document.getElementById("results").innerHTML=html;

}



async function saveData(){

 await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`,{

  method:"PUT",

  headers:{
   "Content-Type":"application/json",
   "X-Master-Key":API_KEY
  },

  body:JSON.stringify(data)

 });

}



loadData();

</script>

</body>
</html>
