<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dictation</title>

<style>

body{
font-family:Arial;
background:linear-gradient(135deg,#4e73df,#1cc88a);
margin:0;
padding:0;
}

.card{
background:white;
max-width:800px;
margin:40px auto;
padding:30px;
border-radius:15px;
text-align:center;
}

button{
background:#4e73df;
color:white;
border:none;
padding:10px 20px;
border-radius:8px;
cursor:pointer;
margin:5px;
}

button:hover{
background:#2e59d9;
}

.word{
margin:10px;
font-size:18px;
}

.secureInput{

display:inline-block;
min-width:200px;
min-height:28px;
border:2px solid #ccc;
border-radius:6px;
padding:4px;
margin-left:10px;
background:white;

}

.secureInput:focus{
outline:none;
border-color:#4e73df;
}

</style>

</head>
<body>

<div class="card">

<h2>Выберите ученика</h2>

<div id="students"></div>

<hr>

<button onclick="location.href='index.html'">Назад</button>

<div id="dictation"></div>

</div>

<script>

const SETTINGS_BIN="698f3a3043b1c97be97c510c";
const API_KEY="$2a$10$sw1K/RXpKK2k3L5l6.wDLuJWKESzfg51etzmCpCb/Q6sEKy0Oudwi";

let currentStudent="";
let words=[];
let answers=[];

loadStudents();

async function loadStudents(){

let res=await fetch(`https://api.jsonbin.io/v3/b/${SETTINGS_BIN}/latest`,{
headers:{"X-Master-Key":API_KEY}
});

let data=await res.json();

let students=data.record.students;

let div=document.getElementById("students");

div.innerHTML="";

for(let name in students){

let btn=document.createElement("button");

btn.innerText=name;

btn.onclick=()=>startDictation(name,students[name]);

div.appendChild(btn);

}

}

function startDictation(name,data){

currentStudent=name;

words=data;

answers=new Array(words.length).fill("");

let html=`<h3>Ученик: ${name}</h3>`;

words.forEach((w,i)=>{

html+=`
<div class="word">

${w.ru}

<div
class="secureInput"
contenteditable="true"
id="input_${i}"
onpaste="return false"
oncopy="return false"
oncut="return false"
ondrop="return false"
oncontextmenu="return false"
onkeydown="protectKey(event)"
oninput="saveAnswer(${i})"
></div>

</div>
`;

});

html+=`<button onclick="submit()">Отправить</button>`;

html+=`<button onclick="newAttempt()">Начать новую попытку</button>`;

html+=`<div id="result"></div>`;

document.getElementById("dictation").innerHTML=html;

}

function saveAnswer(i){

let text=document.getElementById("input_"+i).innerText;

answers[i]=text.trim().toLowerCase();

}

function protectKey(e){

if(e.ctrlKey) e.preventDefault();

}

async function submit(){

let correct=0;

let detail="";

words.forEach((w,i)=>{

let ok=answers[i]==w.en.toLowerCase();

if(ok) correct++;

detail+=`${w.ru} → ${answers[i]} ${ok?"✓":"✗ ("+w.en+")"}<br>`;

});

let percent=Math.round(correct/words.length*100);

document.getElementById("result").innerHTML=
`<h3>${percent}%</h3>${detail}`;

saveResult(percent,detail);

}

function newAttempt(){

answers=new Array(words.length).fill("");

words.forEach((w,i)=>{

document.getElementById("input_"+i).innerText="";

});

document.getElementById("result").innerHTML="";

}

async function saveResult(percent,detail){

let res=await fetch(`https://api.jsonbin.io/v3/b/${SETTINGS_BIN}/latest`,{
headers:{"X-Master-Key":API_KEY}
});

let data=await res.json();

let results=data.record.results||{};

if(!results[currentStudent])
results[currentStudent]=[];

results[currentStudent].push({

date:new Date().toLocaleString(),

percent:percent,

detail:detail

});

await fetch(`https://api.jsonbin.io/v3/b/${SETTINGS_BIN}`,{

method:"PUT",

headers:{
"Content-Type":"application/json",
"X-Master-Key":API_KEY
},

body:JSON.stringify({

instruction:data.record.instruction,

students:data.record.students,

results:results

})

});

}

</script>

</body>
</html>
