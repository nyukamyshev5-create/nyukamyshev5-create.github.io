<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Tutor</title>

<style>
body{
  font-family:Arial;
  padding:30px;
  background:#f4f6f9;
}

.panel{
  background:white;
  padding:20px;
  border-radius:12px;
  max-width:800px;
  margin:auto;
  box-shadow:0 8px 25px rgba(0,0,0,0.1);
}

button{
  padding:6px 10px;
  margin:5px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#4e73df;
  color:white;
}

button:hover{
  background:#2e59d9;
}

textarea,input{
  width:100%;
  margin:5px 0;
  padding:6px;
}

.hidden{display:none;}
</style>

</head>
<body>

<div id="login" class="panel">

<h2>Вход</h2>
<input type="password" id="pass" placeholder="Введите пароль">
<button onclick="check()">Войти</button>

</div>

<div id="panel" class="panel hidden">

<h2>Инструкция</h2>
<textarea id="instruction" rows="4"></textarea>

<h2>Создать диктант</h2>

Имя ученика:
<input id="studentName">

Слова (формат: дом:house):
<textarea id="words" rows="8"></textarea>

<button onclick="save()">Сохранить</button>

<hr>

<h2>Ученики</h2>
<div id="studentsList"></div>

<hr>

<div id="results"></div>

</div>

<script>

const PASSWORD="tutorai";
const SETTINGS_BIN="698f3a3043b1c97be97c510c";
const API_KEY="$2a$10$sw1K/RXpKK2k3L5l6.wDLuJWKESzfg51etzmCpCb/Q6sEKy0Oudwi";

let settings={};

function check(){
 if(document.getElementById("pass").value===PASSWORD){
   document.getElementById("login").style.display="none";
   document.getElementById("panel").classList.remove("hidden");
   load();
 }else{
   alert("Неверный пароль");
 }
}

async function load(){

 let res=await fetch(`https://api.jsonbin.io/v3/b/${SETTINGS_BIN}/latest`,{
   headers:{"X-Master-Key":API_KEY}
 });

 let data=await res.json();
 settings=data.record;

 if(!settings.students) settings.students={};
 if(!settings.results) settings.results={};

 document.getElementById("instruction").value=settings.instruction||"";

 showStudents();
}

function showStudents(){

 let html="";

 for(let name in settings.students){
   html+=`
   <b>${name}</b>
   <button onclick="viewResult('${name}')">Результаты</button>
   <button onclick="deleteStudent('${name}')">Удалить</button>
   <br><br>`;
 }

 document.getElementById("studentsList").innerHTML=html;
}

async function deleteStudent(name){

 if(confirm("Удалить "+name+"?")){
   delete settings.students[name];
   delete settings.results[name];

   await saveToBin();
   load();
 }

}

async function save(){

 let instruction=document.getElementById("instruction").value;
 let name=document.getElementById("studentName").value.trim();
 let lines=document.getElementById("words").value.split("\n");

 settings.instruction=instruction;

 if(name){

   settings.students[name]=[];

   lines.forEach(line=>{
     if(line.includes(":")){
       let parts=line.split(":");
       settings.students[name].push({
         ru:parts[0].trim(),
         en:parts[1].trim()
       });
     }
   });

 }

 await saveToBin();

 alert("Сохранено");
 load();
}

async function saveToBin(){

 await fetch(`https://api.jsonbin.io/v3/b/${SETTINGS_BIN}`,{
   method:"PUT",
   headers:{
     "Content-Type":"application/json",
     "X-Master-Key":API_KEY
   },
   body:JSON.stringify(settings)
 });

}

function viewResult(name){

 if(!settings.results[name]){
   document.getElementById("results").innerHTML="<p>Нет результатов</p>";
   return;
 }

 let r=settings.results[name];

 let html=`<h3>${name}</h3>
           <p><b>Итог:</b> ${r.percent}%</p><hr>`;

 r.details.forEach(d=>{
   if(d.ok){
     html+=`<p style="color:green">${d.ru} → ${d.answer} ✅</p>`;
   }else{
     html+=`<p style="color:red">${d.ru} → ${d.answer||"(пусто)"} — Ошибка ❌ (Правильно: ${d.correct})</p>`;
   }
 });

 document.getElementById("results").innerHTML=html;
}

</script>

</body>
</html>
