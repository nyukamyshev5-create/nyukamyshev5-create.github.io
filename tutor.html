<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Диктант</title>
</head>

<body>

<h2 id="studentName"></h2>

<div id="test"></div>

<button onclick="check()">Проверить</button>

<button onclick="restart()">Пройти заново</button>

<div id="result"></div>

<script>

const TOKEN="PASTE_NEW_TOKEN_HERE"
const USER="nyukamyshev5"
const REPO="nyukamyshev5-create"

let student=
localStorage.getItem("student")

let words=[]

let sha=""

document.getElementById("studentName")
.innerText=student

load()

async function load(){

const res=await fetch(
`https://api.github.com/repos/${USER}/${REPO}/contents/data.json`
)

const json=await res.json()

sha=json.sha

const data=JSON.parse(atob(json.content))

words=data.students[student].words

render()

}

function render(){

const div=document.getElementById("test")

div.innerHTML=""

words.forEach((w,i)=>{

div.innerHTML+=`

<div>

${w.ru}

<br>

<input id="input${i}">

</div>

<br>

`

})

}

async function check(){

let correct=0

let answers=[]

words.forEach((w,i)=>{

const val=
document.getElementById("input"+i).value.trim()

answers.push(val)

if(val.toLowerCase()==w.en.toLowerCase())
correct++

})

const percent=
Math.round(correct/words.length*100)

document.getElementById("result")
.innerHTML="Результат: "+percent+"%"

await saveAttempt(percent,answers)

}

function restart(){

render()

document.getElementById("result").innerHTML=""

}

async function saveAttempt(percent,answers){

const res=await fetch(
`https://api.github.com/repos/${USER}/${REPO}/contents/data.json`
)

const json=await res.json()

let data=JSON.parse(atob(json.content))

if(!data.students[student].attempts)
data.students[student].attempts=[]

data.students[student].attempts.push({

date:new Date().toLocaleString(),

percent:percent,

answers:answers

})

const content=btoa(
JSON.stringify(data,null,2)
)

await fetch(
`https://api.github.com/repos/${USER}/${REPO}/contents/data.json`,
{
method:"PUT",

headers:{
Authorization:`Bearer ${TOKEN}`
},

body:JSON.stringify({

message:"save attempt",

content:content,

sha:json.sha

})

}
)

}

</script>

</body>
</html>
